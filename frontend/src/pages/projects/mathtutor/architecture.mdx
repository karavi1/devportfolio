import Head from 'next/head'
import Navbar from '@/components/Navbar'
import Footer from '@/components/Footer'
import Mermaid from '@/components/Mermaid'

export const meta = {
  title: 'MathTutor Architecture',
  // subtitle: 'System context, data model, core flows, and minimal deployment',
}

<Head>
  <title>{`${meta.title} | Kaushik Ravi`}</title>
  <meta name="description" content="Architecture diagrams for MathTutor" />
</Head>

<Navbar />

<main className="relative overflow-hidden bg-slate-50">
  <div className="pointer-events-none absolute inset-0 -z-10 bg-gradient-to-b from-slate-50 via-white to-emerald-50" />
  <section className="mx-auto max-w-5xl px-6 pb-16 pt-28">
    <div className="rounded-3xl border border-slate-100 bg-white/80 p-6 shadow-sm backdrop-blur">
      <div className="flex flex-wrap items-center justify-between gap-4">
        <div>
          <p className="text-xs font-semibold uppercase tracking-wide text-emerald-700">
            Architecture
          </p>
          <h1 className="text-3xl md:text-4xl font-bold text-slate-900">{meta.title}</h1>
          <p className="mt-2 max-w-2xl text-slate-600">
            Adaptive math practice that keeps learners in control—structured prompts, transparent
            scoring, and guidance that makes thinking visible.
          </p>
        </div>
        <div className="rounded-2xl bg-emerald-50 px-4 py-3 text-sm font-semibold text-emerald-800">
          FastAPI • React • LLMs • AWS • MySQL
        </div>
      </div>
    </div>

    <article className="prose prose-slate max-w-none dark:prose-invert mt-8">

      {/* ---------------- System Context ---------------- */}
      <h2>System Design</h2>
      <Mermaid chart={`
flowchart LR
  user(("Learner")) -->|HTTPS| fe["React Frontend (optional)"]
  fe --> api["FastAPI Backend (EC2)"]
  api --> db["Amazon RDS (MySQL)"]
  api --> sm["AWS Secrets Manager"]
  api --> cw["CloudWatch Logs/Metrics"]

  %% LLM providers (pluggable)
  subgraph "Model Layer"
    llm_api["LLM Provider API"]
  end

  api --> llm_api
  api --> oss_llm

  %% Optional retrieval for worked examples / formulas
  subgraph "Retrieval (Still to come)"
    vdb["Vector DB"]
    corpus["Example/Formula Corpus"]
  end

  api <---> vdb
  vdb --> corpus
`} />

      <div className="text-sm mt-2">
        The current repo is a POC centered on <b>problem suggestion</b> using an <b>obstacle</b> chosen by the user, a <b>structured prompt</b>, and <b>difficulty classification</b>. The API layer will stay thin while the orchestration and schemas live server-side.
      </div>

      {/* ---------------- Data Model (ERD) ---------------- */}
      <h2 className="mt-8">Data Model (ERD)</h2>
      <Mermaid chart={`
erDiagram
  USER ||--o{ SESSION : "starts"
  SESSION ||--o{ ATTEMPT : "records"
  USER ||--o{ PROBLEM : "custom/authored"
  PROBLEM ||--o{ HINT : "offers"
  PROBLEM ||--o{ PROBLEM_TAG : "labeled_by"
  TOPIC ||--o{ PROBLEM_TAG : "joins"
  PROBLEM ||--o{ CLASSIFICATION : "has"
  ATTEMPT ||--o{ EVAL_FEEDBACK : "receives"

  USER {
    uuid id PK
    string username
    string email
    bool is_admin
  }

  SESSION {
    uuid id PK
    uuid user_id FK
    datetime started_at
    datetime ended_at
    string mode "practice|exam|guided"
  }

  PROBLEM {
    uuid id PK
    uuid author_user_id FK
    string stem
    string solution_latex
    string answer_canonical
    string source "system|user"
    string obstacle "user-selected obstacle"
    int estimated_difficulty "1..5"
    datetime created_at
  }

  HINT {
    uuid id PK
    uuid problem_id FK
    int step_no
    string content
  }

  TOPIC {
    uuid id PK
    string name
  }

  PROBLEM_TAG {
    uuid problem_id FK
    uuid topic_id FK
  }

  CLASSIFICATION {
    uuid id PK
    uuid problem_id FK
    string difficulty_label "easy|medium|hard"
    float difficulty_score
    string[] skills "algebra|calculus|geometry..."
    string rubric_schema "JSON schema for evaluation"
    datetime created_at
  }

  ATTEMPT {
    uuid id PK
    uuid session_id FK
    uuid problem_id FK
    string user_work_latex
    string user_final_answer
    bool is_correct
    datetime attempted_at
  }

  EVAL_FEEDBACK {
    uuid id PK
    uuid attempt_id FK
    string feedback_text
    string rubric_json
    string next_hint
    float confidence
    datetime created_at
  }
`} />

      {/* ---------------- Sequence Diagrams ---------------- */}
      <h2 className="mt-8">Sequence Diagrams</h2>

      {/* Obstacle → Problem Suggestion (Structured Prompt) */}
      <h3>Problem Suggestion (Obstacle → Structured Prompt → Problem + Hints + Classification)</h3>
      <Mermaid chart={`
sequenceDiagram
  autonumber
  actor U as "Learner"
  participant FE as "React FE"
  participant API as "FastAPI"
  participant LLM as "LLM Provider"
  participant DB as "MySQL (RDS)"

  U->>FE: Select obstacle (e.g., "chain rule step isolation")
  FE->>API: POST /api/problems/suggest {obstacle, topic?, target_difficulty?}
  note right of API: Build structured prompt + JSON schema (problem, hints[], classification)
  API->>LLM: Invoke with system+user prompt (JSON-mode)
  LLM-->>API: {problem, hints[], classification}
  API->>DB: INSERT problem, hints, classification, tags
  DB-->>API: IDs
  API-->>FE: 201 {problem_id, stem, hints_preview, difficulty}
  FE-->>U: Render problem with "Show hint" control
`} />

      {/* Stepwise Hints */}
      <h3 className="mt-8">Solve with Stepwise Hints</h3>
      <Mermaid chart={`
sequenceDiagram
  autonumber
  actor U as "Learner"
  participant FE as "React FE"
  participant API as "FastAPI"
  participant DB as "MySQL (RDS)"

  U->>FE: Request next hint
  FE->>API: GET /api/problems/{id}/hints?next=true
  API->>DB: SELECT next hint by step_no
  DB-->>API: hint content
  API-->>FE: 200 {step_no, content}
  FE-->>U: Display hint
  Note over U: User continues work
`} />


      {/* Difficulty Classification (can be on-create or batch) */}
      <h3 className="mt-8">Difficulty Assessment & Classification</h3>
      <Mermaid chart={`
sequenceDiagram
  autonumber
  participant API as "FastAPI"
  participant LLM as "LLM Provider"
  participant DB as "MySQL (RDS)"

  API->>LLM: Classify(problem) → {difficulty_label, score, skills, rubric_schema}
  LLM-->>API: Classification JSON
  API->>DB: UPSERT classification
  DB-->>API: OK
`} />

      {/* Evaluate Answer + Feedback */}
      <h3 className="mt-8">Evaluate Answer & Feedback</h3>
      <Mermaid chart={`
sequenceDiagram
  autonumber
  actor U as "Learner"
  participant FE as "React FE"
  participant API as "FastAPI"
  participant LLM as "LLM Provider"
  participant DB as "MySQL (RDS)"

  U->>FE: Submit final answer (+ optional work)
  FE->>API: POST /api/attempts {problem_id, user_final_answer, user_work_latex}
  API->>DB: INSERT attempt (pending)
  DB-->>API: attempt_id

  API->>LLM: Evaluate via rubric
  Note over API,LLM: Compare to canonical solution and check steps
  API->>DB: UPDATE attempt (is_correct)
  API->>DB: INSERT eval_feedback (attempt_id, feedback, rubric_json, next_hint, confidence)
  DB-->>API: OK

  API-->>FE: 200 {is_correct, feedback_text, next_hint}
  FE-->>U: Show result
  Note over U: Learner can retry or move to next problem
`} />


      {/* ---------------- Minimal Deployment Diagram ---------------- */}
      <h2 className="mt-10">Minimal Deployment Diagram</h2>
      <Mermaid chart={`
flowchart LR
  user(("Learner"))
  cdn["CDN/Edge (Vercel/Static Assets)"]
  fe["React App"]
  lb["Nginx Reverse Proxy"]
  app["Gunicorn/Uvicorn<br/>FastAPI on EC2"]
  rds["Amazon RDS (MySQL)"]
  sm["AWS Secrets Manager"]
  cw["CloudWatch Logs/Metrics"]
  llm_api["LLM Provider API"]

  user -->|HTTPS| cdn --> fe
  fe -->|HTTPS API| lb --> app
  app --> rds
  app --> sm
  app --> cw
  app --> llm_api
  app <---> vdb
`} />

      <ul className="text-sm mt-2">
        <li><b>Nginx</b>: TLS termination, gzip, reverse proxy to Gunicorn/Uvicorn.</li>
        <li><b>FastAPI</b>: Orchestrates structured prompts + JSON schemas</li>
        <li><b>RDS MySQL</b>: Stores problems, hints, attempts, evaluations, and classifications.</li>
        <li><b>Secrets Manager</b>: DB and LLM API keys kept out of code; rotate regularly.</li>
        <li><b>CloudWatch</b>: Logs/metrics; alarms on error rate and latency.</li>
      </ul>

    </article>
  </section>
</main>

<Footer />
