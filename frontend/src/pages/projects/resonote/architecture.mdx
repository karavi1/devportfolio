import Head from 'next/head'
import Navbar from '@/components/Navbar'
import Footer from '@/components/Footer'
import Mermaid from '@/components/Mermaid'

export const meta = {
  title: 'Resonote Architecture',
  subtitle: '',
}

<Head>
  <title>{`${meta.title} | Kaushik Ravi`}</title>
  <meta name="description" content="Architecture diagrams for Resonote" />
</Head>

<Navbar />

<main className="relative overflow-hidden bg-slate-50">
  <div className="pointer-events-none absolute inset-0 -z-10 bg-gradient-to-b from-slate-50 via-white to-emerald-50" />
  <section className="mx-auto max-w-5xl px-6 pb-16 pt-28">
    <div className="rounded-3xl border border-slate-100 bg-white/80 p-6 shadow-sm backdrop-blur">
      <div className="flex flex-wrap items-center justify-between gap-4">
        <div>
          <p className="text-xs font-semibold uppercase tracking-wide text-emerald-700">
            Architecture
          </p>
          <h1 className="text-3xl md:text-4xl font-bold text-slate-900">{meta.title}</h1>
          <p className="mt-2 max-w-2xl text-slate-600">
            Reading, reflection, and knowledge graphs built to help people retain what matters and
            think for themselves.
          </p>
        </div>
        <div className="rounded-2xl bg-emerald-50 px-4 py-3 text-sm font-semibold text-emerald-800">
          Flask • React • AWS • MySQL • NLP
        </div>
      </div>
    </div>

    <article className="prose prose-slate max-w-none dark:prose-invert mt-8">

      {/* ---------------- System Context ---------------- */}
      <h2>System Design</h2>
      <Mermaid chart={`
flowchart LR
  user(("User")) -->|HTTPS| fe["React (Vite) Frontend"]
  fe --> api["Flask API (EC2)"]
  api --> rds["Amazon RDS (MySQL)"]
  api --> sm["AWS Secrets Manager"]
  api --> cw["CloudWatch Logs/Metrics"]
  subgraph Ingestion
    fetch["Fetchers (Substack/Guardian/Reddit)"]
    curate["Curation Pipeline"]
    indexer["Indexing Service"]
  end
  fetch --> curate --> indexer --> api
`} />

      <div className="text-sm mt-2">
        Resonote focuses on 4 modular components: <b>ingestion → curation → indexing → reflection</b>. It’s online-first, so users open source links directly at the original site. 
      </div>


      {/* ---------------- Data Model (ERD) ---------------- */}
      <h2 className="mt-8">Data Model (ERD)</h2>
      <Mermaid chart={`
erDiagram
  CURATED_ARTICLE ||--|| REFLECTION : has
  CURATED_ARTICLE ||--o{ ARTICLE_TAG_ASSOCIATION : labeled_by
  TAG ||--o{ ARTICLE_TAG_ASSOCIATION : joins

  CURATED_ARTICLE {
    int id PK
    string title
    string author "nullable"
    text url
    string url_hash "unique"
    string source
    int estimated_reading_time_min
    string reading_status "default: unread"
    datetime timestamp "UTC now"
    bool favorite "default: false"
  }

  REFLECTION {
    int id PK
    int article_id FK "unique (1:1 with article)"
    text content
    datetime created_at
    datetime updated_at
  }

  TAG {
    int id PK
    string name "unique"
  }

  ARTICLE_TAG_ASSOCIATION {
    int article_id PK, FK
    int tag_id PK, FK
  }
`} />

      {/* ---------------- Sequence Diagrams ---------------- */}
      <h2 className="mt-8">Sequence Diagrams</h2>

      {/* Ingestion + Curation + Indexing */}
      <h3>Ingestion → Curation → Indexing</h3>
      <Mermaid chart={`
sequenceDiagram
  autonumber
  participant SCH as Scheduler (cron)
  participant F as Fetchers (Substack/Guardian/Reddit)
  participant C as Curation Pipeline
  participant I as Indexing Service
  participant API as Flask API
  participant DB as MySQL (RDS)

  SCH->>F: Trigger fetch (per source)
  loop sources
    F->>F: Pull latest feeds/posts
    F-->>C: Raw items (title, url, author, published_at, content/summary)
    C->>C: Deduplicate, quality checks, normalize fields
    C-->>I: Curated items
    I->>DB: Upsert CURATED_ARTICLE (+ derived tags)
    I->>DB: Upsert TAG and ARTICLE_TAG relations
  end
  DB-->>API: Indexed catalog available
`} />

      {/* List & Filter Articles */}
      <h3 className="mt-8">List & Filter Articles (Unread / Favorite / By Source or Tag)</h3>
      <Mermaid chart={`
sequenceDiagram
  autonumber
  actor U as User
  participant FE as React (Vite)
  participant API as Flask API
  participant DB as MySQL (RDS)

  U->>FE: Open "Articles" page (filters: unread, favorites, source, tag)
  FE->>API: GET /api/articles?read=false&favorite?=&source?=&tag?=
  API->>DB: SELECT curated_article JOIN tags (with filters, pagination)
  DB-->>API: Articles (DTOs)
  API-->>FE: 200 {items, pagination}
  FE-->>U: Render vertical cards grouped by primary tag
`} />

      {/* Mark as Read */}
      <h3 className="mt-8">Mark as Read</h3>
      <Mermaid chart={`
sequenceDiagram
  autonumber
  actor U as User
  participant FE as React (Vite)
  participant API as Flask API
  participant DB as MySQL (RDS)

  U->>FE: Click "Mark as Read"
  FE->>API: PATCH /api/articles/{id}/read {is_read: true}
  API->>DB: UPDATE curated_article SET is_read=true
  DB-->>API: OK
  API-->>FE: 200 {id, is_read:true}
  FE-->>U: Update card state in place (optimistic or on success)
`} />

      {/* Toggle Favorite */}
      <h3 className="mt-8">Toggle Favorite</h3>
      <Mermaid chart={`
sequenceDiagram
  autonumber
  actor U as User
  participant FE as React (Vite)
  participant API as Flask API
  participant DB as MySQL (RDS)

  U->>FE: Click "Favorite"
  FE->>API: PATCH /api/articles/{id}/favorite {is_favorite: !current}
  API->>DB: UPDATE curated_article SET is_favorite = value
  DB-->>API: OK
  API-->>FE: 200 {id, is_favorite:value}
  FE-->>U: Toggle favorite icon
`} />

      {/* Add or Edit Reflection */}
      <h3 className="mt-8">Add / Edit Reflection</h3>
      <Mermaid chart={`
sequenceDiagram
  autonumber
  actor U as User
  participant FE as React (Vite)
  participant API as Flask API
  participant DB as MySQL (RDS)

  U->>FE: Click "Edit Reflection"
  alt create new
    FE->>API: POST /api/reflections {article_id, content}
    API->>DB: INSERT reflection (user_id, article_id, content)
    DB-->>API: reflection_id
    API-->>FE: 201 {id, content, timestamps}
    FE-->>U: Render reflection text
  else update existing
    FE->>API: PUT /api/reflections/{id} {content}
    API->>DB: UPDATE reflection SET content=?, updated_at=NOW()
    DB-->>API: OK
    API-->>FE: 200 {id, content, updated_at}
    FE-->>U: Update reflection text
  end
`} />

      {/* ---------------- Knowledge Graph ---------------- */}
      <h2 className="mt-8">Knowledge Graph Dashboard</h2>

      <h3>Knowledge Graph — Load & Build</h3>
      <Mermaid chart={`
sequenceDiagram
  autonumber
  actor U as User
  participant FE as React (Vite) Dashboard
  participant API as Flask API
  participant DB as MySQL (RDS)

  U->>FE: Open Dashboard
  FE->>API: GET /api/articles
  API->>DB: SELECT curated_articles LEFT JOIN tags
  DB-->>API: rows (articles with tags)
  API-->>FE: 200 JSON (articles[])
  FE->>FE: Build nodes (articles, tags) and links
  Note over FE: Article nodes: blue<br/>Tag nodes: purple
  FE->>FE: Compute tag frequencies & summary stats
  FE-->>U: Render All + Read-only graphs and stats
`} />

      <h3 className="mt-8">Knowledge Graph — Force Layout & Render</h3>
      <Mermaid chart={`
sequenceDiagram
  autonumber
  participant FE as React (Vite)
  participant D3 as D3 Force Simulation
  participant CAN as Canvas (react-force-graph-2d)

  FE->>D3: Init forces (charge, link.id, collide)
  FE->>D3: Add X/Y forces (stronger for tag nodes)
  D3-->>FE: Tick updates (x,y)
  FE->>CAN: Draw nodes and links per tick
  loop until cooldownTicks
    D3-->>FE: Tick...
    FE->>CAN: Repaint
  end
  D3-->>FE: Engine stop
  FE->>FE: zoomToFit(400)
  FE-->>CAN: Final settled layout
`} />

      <h3 className="mt-8">Knowledge Graph — User Interactions</h3>
      <Mermaid chart={`
sequenceDiagram
  autonumber
  actor U as User
  participant FE as React (Vite)
  participant CAN as Canvas

  U->>FE: Click "Fit to View"
  FE->>CAN: zoomToFit(400)
  CAN-->>U: View centers on graph

  U->>CAN: Hover node
  CAN-->>U: Tooltip label (Article title / Tag)

  U->>FE: Switch to "Read Articles Only"
  FE->>FE: Filter articles where reading_status = read
  FE->>CAN: Re-render read-only graph
  CAN-->>U: Updated layout and stats
`} />

      {/* ---------------- Minimal Deployment Diagram ---------------- */}
      <h2 className="mt-10">Minimal Deployment Diagram</h2>
      <Mermaid chart={`
flowchart LR
  user(("User"))
  cdn["CDN/Edge (Vercel/Static Assets)"]
  fe["React (Vite) App"]
  lb["Nginx Reverse Proxy"]
  app["Gunicorn<br/>Flask on EC2"]
  rds["Amazon RDS (MySQL)"]
  sm["AWS Secrets Manager"]
  cw["CloudWatch Logs/Metrics"]

  user -->|HTTPS| cdn --> fe
  fe -->|HTTPS API| lb --> app
  app --> rds
  app --> sm
  app --> cw
`} />

      <ul className="text-sm mt-2">
        <li><b>Nginx</b>: TLS termination, static gzip, reverse proxy to Gunicorn (Flask).</li>
        <li><b>Gunicorn</b>: WSGI server for Flask; tune workers/threads for EC2 size.</li>
        <li><b>RDS MySQL</b>: primary store; enable automated backups and snapshots.</li>
        <li><b>CloudWatch</b>: app & ingestion logs; dashboards + alarms on errors/latency.</li>
        <li><b>Secrets Manager</b>: DB creds and API keys (e.g., for sources) rotated out of code.</li>
      </ul>

    </article>
  </section>
</main>

<Footer />
